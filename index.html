<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Programação Web Assíncrona com Goliath</title>

  <meta name="viewport" content="width=device-width"/>

  <link rel="stylesheet" href="./css/reset.css" type="text/css"/>
  <link rel="stylesheet" href="./css/showoff.css" type="text/css"/>

  <script type="text/javascript" src="./js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="./js/jquery.cycle.all.js"></script>
	<script type="text/javascript" src="./js/jquery-print.js"></script>
  <script type="text/javascript" src="./js/jquery.batchImageLoad.js"></script>

  <script type="text/javascript" src="./js/jquery.doubletap-0.1.js"></script>

  <script type="text/javascript" src="./js/fg.menu.js"></script>
  <script type="text/javascript" src="./js/showoff.js"></script>
  <script type="text/javascript" src="./js/jTypeWriter.js"> </script>
  <script type="text/javascript" src="./js/sh_main.min.js"></script>
  <script type="text/javascript" src="./js/core.js"></script>
  <script type="text/javascript" src="./js/showoffcore.js"></script>
  <script type="text/javascript" src="./js/coffee-script.js"></script>

  <link type="text/css" href="./css/fg.menu.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/theme/ui.all.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/sh_style.css" rel="stylesheet" >

  
    <link rel="stylesheet" href="file/style.css" type="text/css"/>
  

  

  <script type="text/javascript">
  $(function(){
      setupPreso(false, './');
  });
  </script>

</head>

<body>

<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>

<div id="help">
  <table>
    <tr><td class="key">z, ?</td><td>toggle help (this)</td></tr>
    <tr><td class="key">space, &rarr;</td><td>next slide</td></tr>
    <tr><td class="key">shift-space, &larr;</td><td>previous slide</td></tr>
    <tr><td class="key">d</td><td>toggle debug mode</td></tr>
    <tr><td class="key">## &lt;ret&gt;</td><td>go to slide #</td></tr>
    <tr><td class="key">c, t</td><td>table of contents (vi)</td></tr>
    <tr><td class="key">f</td><td>toggle footer</td></tr>
    <tr><td class="key">r</td><td>reload slides</td></tr>
    <tr><td class="key">n</td><td>toggle notes</td></tr>
    <tr><td class="key">p</td><td>run preshow</td></tr>
  </table>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso">loading presentation...</div>
<div id="footer">
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
</div>

<div id="slides" class="offscreen" style="display:none;">
<div class="slide" data-transition="none"><div class="content" ref="one/01_slide/1">
<h1>Programa&#xE7;&#xE3;o Web Ass&#xED;ncrona com Goliath</h1></div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="one/01_slide/2">
<h1>Cain&#xE3; Costa</h1>

<ul>
<li>@sryche</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets" ref="one/01_slide/3">
<h1>Disclaimer</h1>

<ul>
<li>Minha primeira palestra na vida.</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content center" ref="one/01_slide/4">
<h1>EVENTOS!!!1!onze!1</h1>

<p><img src="./file/one/ariel-hipster.jpg" alt="Eventos!"/></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/5">
<h1>EventMachine</h1>

<ul>
<li>Muito tempo perdido esperando I/O (Aplica&#xE7;&#xF5;es I/O Bound)</li>
<li>Pouco tempo de real processamento</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/6">
<h1>EventMachine</h1>

<ul>
<li>Pe&#xE7;a por I/O</li>
<li>Processe outras coisas</li>
<li>Quando o I/O voltar, continue o que estava fazendo</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/7">
<h1>Callbacks!</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/8">
<h1>Eventos s&#xE3;o maneiros, mas...</h1>

<ul>
<li>Eles s&#xE3;o dif&#xED;ceis de testar</li>
<li>Eles s&#xE3;o dif&#xED;ceis de acompanhar</li>
<li>Eles n&#xE3;o s&#xE3;o o que a maioria de n&#xF3;s est&#xE1; acostumada...</li>
<li>Callback hell! :-(</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/9">
<h1>Temos outras op&#xE7;&#xF5;es?</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/10">
<h1>Threads no MRI n&#xE3;o s&#xE3;o concorrentes!</h1>

<ul>
<li>(jRuby e Rubinius 2.0 escapam dessa)</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content center" ref="one/01_slide/11">
<h1>Global Interpreter Lock</h1>

<p><img src="./file/one/ruby-gil.png" alt="Global Interpreter Lock"/></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/12">
<h1>Fair Scheduler</h1>

<ul>
<li>Cada Thread tem um tempo (10ms) para rodar</li>
<li>Ap&#xF3;s isso, ela &#xE9; interrompida e a pr&#xF3;xima toma seu lugar</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/13">
<h1>Fibers</h1>

<ul>
<li>Funcionam de maneiras parecidas com Threads</li>
<li>O scheduling fica a cargo do programador</li>
<li>Mais leve/r&#xE1;pido, mas mais complexo</li>
<li>Sem concorr&#xEA;ncia</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content center" ref="one/01_slide/14">
<h1>Fibers vs Threads</h1>

<p><img src="./file/one/fibers-vs-threads.png" alt="Fibers vs Threads"/></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/15">
<h1>Ok, mas como isso nos ajuda com nosso problema?</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/16">
<h1>EventMachine!</h1>

<ul>
<li>O EM roda I/Os em Threads separadas, e retorna um callback quando terminam</li>
<li>Podemos colocar todo nosso c&#xF3;digo em Fibers, parar e resumir quando acabar</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/17">
<h1>Podemos transformar isso...</h1>

<pre class="sh_ruby"><code>require 'eventmachine'
require 'em-http'

EM.run do
  url = "http://jsonip.com"
  http = EM::HttpRequest.new(url).get timeout: 10
  http.callback do |data|
    url = "http://localhost:9292"
    http = EM::HttpRequest.new(url).post timeout: 10,
                                                body: {ip: data.response}

    http.callback do |data|
      puts data.response

      EM.stop
    end
  end
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/18">
<h1>Num peda&#xE7;o de amor em forma de c&#xF3;digo</h1>

<pre class="sh_ruby"><code>require 'fiber'
require 'eventmachine'
require 'em-http'

def async_fetch(url, method = :get, params = {timeout: 10})
  f = Fiber.current
  http = EM::HttpRequest.new(url).send(method, params)
  http.callback { f.resume(http) }

  return Fiber.yield
end

EM.run do
  Fiber.new{
    puts "Setting up HTTP request #1"
    data = async_fetch('http://jsonip.com/')

    post = async_fetch('http://localhost:9292/',
                       :post, timeout: 10, body: {ip: data.response})

    puts post.response

    EM.stop
  }.resume
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/19">
<h1>Yay!</h1>

<pre class="sh_ruby"><code>data = async_fetch('http://jsonip.com/')

post = async_fetch('http://localhost:9292/',
    :post, timeout: 10, body: {ip: data.response})

puts post.response</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/20">
<h1>EventMachine::Synchrony</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/21">
<h1>Lembra do nosso exemplo? Ent&#xE3;o...</h1>

<pre class="sh_ruby"><code>EM.run do
  EM.synchrony do
    data = EM::HttpRequest.new('http://jsonip.com/').get

    post = EM::HttpRequest.new('http://localhost:9292/').
                           post(timeout: 10, body: {ip: data.response})

    puts post.response

    EM.stop
  end
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/22">
<h1>O EM::Synchrony cuida da parte complicada pra gente...</h1>

<ul>
<li>Coloca o bloco inteiro dentro de uma Fiber</li>
<li>Cuida do scheduling da Fiber para parar/retornar assim que um I/O blocante ocorrer</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/23">
<h1>Mas e se isso fosse aplicado para o Rack?</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/24">
<h1>Goliath!</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/25">
<h1>EventMachine + HTTP Parser r&#xE1;pido + Fibers = &lt;3</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/26">
<h1>Goliath::API</h1>

<ul>
<li>Todo "Service" deve herdar dessa classe</li>
<li>Fornece m&#xE9;todos para cuidar de requisi&#xE7;&#xF5;es HTTP</li>
<li>A API &#xE9; diferente do rack, mas funciona da mesma maneira</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/27">
<h1>Um "Service" do Goliath</h1>

<pre class="sh_ruby"><code>require 'goliath'

class Hello &lt; Goliath::API
  def response(env)
    [200, {}, "Hello World"]
  end
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/28">
<h1>Middlewares</h1>

<ul>
<li>Possuem interface parecida com os do Rack, e funcionam da mesma maneira</li>
<li>Funcionam por composi&#xE7;&#xE3;o, podendo ser acumulados</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/29">
<h1>Middlewares</h1>

<pre class="sh_ruby"><code>require 'goliath'

class Hello &lt; Goliath::API
  use Goliath::Rack::Params # Te permite acessar os par&#xE2;metros rack-style
  use Goliath::Rack::DefaultMimeType  # Define Mime-types!
  use Goliath::Rack::Formatters::JSON  # Responde com JSON
  use Goliath::Rack::Render  # Adiciona o content-type automagicamente
  use Goliath::Rack::Heartbeat # responde em /status with 200 (Monitoramento)

  def response(env)
    [200, {}, "Hello World"]
  end
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/30">
<h1>Streaming</h1>

<ul>
<li>Suportado nativamente, e com EventMachine fica ainda mais f&#xE1;cil</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/31">
<h1>Streaming</h1>

<pre class="sh_ruby"><code>require 'goliath'

class Stream &lt; Goliath::API
  def on_close(env)
    env.logger.info "Connection closed."
  end

  def response(env)
    i = 0
    pt = EM.add_periodic_timer(1) do
      env.stream_send("#{i}\n")
      i += 1
    end

    EM.add_timer(10) do
      pt.cancel

      env.stream_send("!! BOOM !!\n")
      env.stream_close
    end

    streaming_response(202, {'X-Stream' =&gt; 'Goliath'})
  end
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/32">
<h1>Roteamento</h1>

<ul>
<li>&#xC9; feito com uma camada de Proxy, ligando cada servi&#xE7;o a um path.</li>
<li>A classe de proxy n&#xE3;o precisa definir o m&#xE9;todo #response</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/33">
<h1>Roteamento</h1>

<pre class="sh_ruby"><code>class HelloWorld &lt; Goliath::API
  def response(env) ; [200, {}, 'Hello World!']
end

class PostHelloWorld &lt; Goliath::API
  def response(env) ; [200, {}, 'Hello World!']
end

class APIRouter &lt; Goliath::API
  get '/hello_world', HelloWorld
  post '/hello_world', PostHelloWorld
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/34">
<h1>Configura&#xE7;&#xE3;o</h1>

<ul>
<li>O goliath carrega automaticamente um arquivo com o mesmo nome, dentro da pasta <code>./config</code></li>
<li>Dentro desse arquivo, <code>config</code> fica dispon&#xED;vel como um hash.</li>
<li>Chaves definidas por esse hash viram m&#xE9;todos dentro do arquivo source.</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/35">
<h1>Configura&#xE7;&#xE3;o</h1>

<pre class="sh_ruby"><code># Na config
config['redis'] = Redis.new

# No c&#xF3;digo
def response(env)
  redis
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/36">
<h1>Testando</h1>

<ul>
<li>Testar c&#xF3;digo do Goliath &#xE9; t&#xE3;o simples quanto testar c&#xF3;digo n&#xE3;o evented.</li>
<li>O Goliath fornece um test_helper chamado <code>with_api(api_class)</code>, e o c&#xF3;digo roda dentro de um bloco</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/37">
<h1>Testando</h1>

<pre class="sh_ruby"><code># spec_helper.rb
require 'goliath/test_helper'
RSpec.configure do |c|
  c.include Goliath::TestHelper
end

# E no teste...
describe MyApi do
  it "should work" do
    with_api(MyApi) do |api|
      api.config['mysql'] = mock # Dependency Injection!
      response = get_request(path: '/status')
      response.response_header.status.should eq 200
    end
  end
end</code></pre></div>
</div><div class="slide" data-transition="none"><div class="content center" ref="one/01_slide/38">
<p><img src="./file/one/thanks.jpg" alt="Thanks!"/></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/39">
<h1>Food for thought</h1>

<ul>
<li>nio4r, celluloid, celluloid-io (ruby)</li>
<li>NIO, Netty (java)</li>
<li>node-fibers (javascript)</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/40">
<h1>Refer&#xEA;ncias</h1>

<ul>
<li>http://goliath.io</li>
<li>http://ruby-doc.org/core-1.9.3/Fiber.html</li>
<li>http://www.igvita.com/2009/05/13/fibers-cooperative-scheduling-in-ruby/</li>
<li>http://www.igvita.com/2010/03/22/untangling-evented-code-with-ruby-fibers/</li>
</ul>
</div>
</div></div>

</body>
</html>
